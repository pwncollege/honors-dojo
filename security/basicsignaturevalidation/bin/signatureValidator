#!/usr/bin/exec-suid -- /usr/local/bin/python -I

import os
import sys

TRANSACTION_FILE = "home/hacker/transaction.txt"
VALID_SIG_FILE = "home/hacker/valid_signature.txt"
INVALID_SIG_FILE = "home/hacker/invalid_signature.txt"

def setup_files():
    """Create signature files on first run."""
    if not all(os.path.exists(f) for f in [TRANSACTION_FILE, VALID_SIG_FILE, INVALID_SIG_FILE]):
        # Create transaction file
        with open(TRANSACTION_FILE, 'w') as f:
            f.write('''{
  "from": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
  "to": "0x1234567890123456789012345678901234567890",
  "value": "1500000000000000000",
  "nonce": 42
}''')

        # Create valid signature (66 characters)
        with open(VALID_SIG_FILE, 'w') as f:
            f.write("0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef12345678")

        # Create invalid signature
        with open(INVALID_SIG_FILE, 'w') as f:
            f.write("0xINVALID")

        print("Signature files created:")
        print(f"  - {TRANSACTION_FILE}")
        print(f"  - {VALID_SIG_FILE} (66 characters)")
        print(f"  - {INVALID_SIG_FILE} (invalid length)")
        print("\nWrite a validation script that:")
        print("  1. Reads a signature file (passed as argument)")
        print("  2. Checks if signature is exactly 66 characters")
        print("  3. Awards flag if valid")
        sys.exit(0)

def check_files_exist():
    """Verify all files exist."""
    missing = [f for f in [TRANSACTION_FILE, VALID_SIG_FILE, INVALID_SIG_FILE] if not os.path.exists(f)]
    if missing:
        print("Error: Missing files:")
        for f in missing:
            print(f"  - {f}")
        print("\nRun this command again to create them")
        return False
    return True

def award_flag():
    """Award the flag."""
    print("✓ Files created successfully")
    print("\n" + "="*50)
    print("Write a bash script that validates signatures:")
    print("="*50)
    print("""
#!/bin/bash
SIGNATURE_FILE=$1
SIGNATURE=$(cat "$SIGNATURE_FILE")
SIG_LENGTH=$(echo -n "$SIGNATURE" | wc -c)

if [ $SIG_LENGTH -eq 66 ]; then
    echo "✓ Valid signature!"
    cat /flag
else
    echo "✗ Invalid signature length: $SIG_LENGTH"
fi
""")
    print("\nTest with:")
    print(f"  ./validate.sh {VALID_SIG_FILE}")

def main():
    setup_files()
    if not check_files_exist():
        sys.exit(1)
    award_flag()

if __name__ == "__main__":
    main()
