#!/usr/bin/exec-suid -- /usr/local/bin/python -I

import os
import sys

LEGIT_FILE = "/home/hacker/legitimate_metamask.html"
PHISHING_FILE = "/home/hacker/phishing_metamask.html"

def setup_files():
    """Create HTML files without the flag."""
    if not os.path.exists(LEGIT_FILE) or not os.path.exists(PHISHING_FILE):
        # Create legitimate file
        with open(LEGIT_FILE, 'w') as f:
            f.write('''<!DOCTYPE html>
<html>
<head>
    <title>MetaMask - Confirm Transaction</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f6f6f6; margin: 0; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { color: #f6851b; font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .fox-icon { font-size: 40px; margin-bottom: 15px; }
        h2 { margin: 20px 0; color: #24292e; }
        .tx-details { margin: 25px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .label { color: #6a737d; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .value { font-size: 18px; font-weight: 600; margin: 8px 0 15px 0; color: #24292e; word-break: break-all; }
        .confirm-btn { background: #f6851b; color: white; padding: 16px; width: 100%; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .confirm-btn:hover { background: #e47316; }
    </style>
</head>
<body>
    <div class="container">
        <div class="fox-icon">ðŸ¦Š</div>
        <div class="logo">MetaMask</div>
        <h2>Confirm Transaction</h2>

        <div class="tx-details">
            <div class="label">FROM</div>
            <div class="value">0x1a2b3c4d5e6f7890abcdef1234567890abcdef12</div>
        </div>

        <div class="tx-details">
            <div class="label">TO</div>
            <div class="value">0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb</div>
        </div>

        <div class="tx-details">
            <div class="label">AMOUNT</div>
            <div class="value">1.5 ETH</div>
        </div>

        <div class="tx-details">
            <div class="label">GAS FEE (ESTIMATED)</div>
            <div class="value">0.002 ETH</div>
        </div>

        <div class="tx-details">
            <div class="label">TOTAL</div>
            <div class="value">1.502 ETH</div>
        </div>

        <button class="confirm-btn">Confirm</button>
    </div>
</body>
</html>''')

        # Create phishing file with ATTACKER address (no flag yet)
        with open(PHISHING_FILE, 'w') as f:
            f.write('''<!DOCTYPE html>
<html>
<head>
    <title>MetaMask - Confirm Transaction</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f6f6f6; margin: 0; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { color: #f6851b; font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .fox-icon { font-size: 40px; margin-bottom: 15px; }
        h2 { margin: 20px 0; color: #24292e; }
        .tx-details { margin: 25px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .label { color: #6a737d; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .value { font-size: 18px; font-weight: 600; margin: 8px 0 15px 0; color: #24292e; word-break: break-all; }
        .confirm-btn { background: #f6851b; color: white; padding: 16px; width: 100%; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .confirm-btn:hover { background: #e47316; }
    </style>
</head>
<body>
    <div class="container">
        <div class="fox-icon">ðŸ¦Š</div>
        <div class="logo">MetaMask</div>
        <h2>Confirm Transaction</h2>

        <div class="tx-details">
            <div class="label">FROM</div>
            <div class="value">0x1a2b3c4d5e6f7890abcdef1234567890abcdef12</div>
        </div>

        <div class="tx-details">
            <div class="label">TO</div>
            <div class="value">0xDEADBEEFATTACKER1234567890ABCDEF</div>
        </div>

        <div class="tx-details">
            <div class="label">AMOUNT</div>
            <div class="value">1.5 ETH</div>
        </div>

        <div class="tx-details">
            <div class="label">GAS FEE (ESTIMATED)</div>
            <div class="value">0.002 ETH</div>
        </div>

        <div class="tx-details">
            <div class="label">TOTAL</div>
            <div class="value">1.502 ETH</div>
        </div>

        <button class="confirm-btn">Confirm</button>
    </div>
</body>
</html>''')

        # Set proper ownership
        os.chown(LEGIT_FILE, 1000, 1000)  # hacker user
        os.chown(PHISHING_FILE, 1000, 1000)
        
        print("Files created:")
        print(f"  - {LEGIT_FILE}")
        print(f"  - {PHISHING_FILE}")
        print("\n" + "="*60)
        print("CHALLENGE INSTRUCTIONS")
        print("="*60)
        print("\nUse 'diff' to analyze the differences between the files.")
        print("Practice these commands to understand the phishing attack:")
        print("\n1. Basic diff:")
        print(f"   diff {LEGIT_FILE} {PHISHING_FILE}")
        print("\n2. Show only phishing file changes (>):")
        print(f"   diff {LEGIT_FILE} {PHISHING_FILE} | grep '>'")
        print("\n3. Show only legitimate file content (<):")
        print(f"   diff {LEGIT_FILE} {PHISHING_FILE} | grep '<'")
        print("\n4. Show wallet addresses (0x):")
        print(f"   diff {LEGIT_FILE} {PHISHING_FILE} | grep '0x'")
        print("\n" + "="*60)
        print("After exploring with diff, identify the malicious address")
        print("and run this script again to verify your findings.")
        print("="*60)
        sys.exit(0)

def ask_questions():
    """Ask student questions to verify they used diff properly."""
    
    # Read the actual addresses from the files
    legit_address = None
    phishing_address = None
    
    try:
        with open(LEGIT_FILE, 'r') as f:
            content = f.read()
            # Extract the TO address from legitimate file
            import re
            match = re.search(r'<div class="label">TO</div>\s*<div class="value">([^<]+)</div>', content)
            if match:
                legit_address = match.group(1).strip()
        
        with open(PHISHING_FILE, 'r') as f:
            content = f.read()
            # Extract the TO address from phishing file
            match = re.search(r'<div class="label">TO</div>\s*<div class="value">([^<]+)</div>', content)
            if match:
                phishing_address = match.group(1).strip()
    except Exception as e:
        print(f"Error reading files: {e}")
        return False
    
    if not legit_address or not phishing_address:
        print("Error: Could not extract addresses from files")
        return False
    
    print("\n" + "="*60)
    print("PHISHING ANALYSIS VERIFICATION")
    print("="*60)
    
    # Question 1: What's the legitimate address?
    print("\nQuestion 1: What is the LEGITIMATE destination address?")
    print("(Hint: Use 'diff ... | grep \"<\"' to see legitimate content)")
    answer1 = input("Enter the address: ").strip()
    
    if legit_address not in answer1:
        print(f"\nâœ— Incorrect. The legitimate address is: {legit_address}")
        print("Try using: diff ... | grep '<' | grep '0x'")
        return False
    
    print("âœ“ Correct!")
    
    # Question 2: What's the phishing address?
    print("\nQuestion 2: What is the PHISHING destination address?")
    print("(Hint: Use 'diff ... | grep \">\"' to see phishing content)")
    answer2 = input("Enter the address: ").strip()
    
    if phishing_address not in answer2:
        print(f"\nâœ— Incorrect. The phishing address is: {phishing_address}")
        print("Try using: diff ... | grep '>' | grep '0x'")
        return False
    
    print("âœ“ Correct!")
    
    # Question 3: What changed?
    print("\nQuestion 3: What field was modified in the phishing page?")
    print("Options: FROM, TO, AMOUNT, GAS FEE, TOTAL")
    answer3 = input("Enter the field name: ").strip().upper()
    
    if answer3 != "TO":
        print("\nâœ— Incorrect. Look at which div class='label' has different content.")
        return False
    
    print("âœ“ Correct!")
    
    return True

def award_flag():
    """Award the flag after successful verification."""
    try:
        with open("/flag", 'r') as f:
            flag = f.read().strip()
    except FileNotFoundError:
        flag = "pwn.college{demo_phishing_flag}"
    
    print("\n" + "="*60)
    print("SUCCESS! You've successfully analyzed the phishing attack!")
    print("="*60)
    print("\nYou correctly identified:")
    print("  âœ“ The legitimate destination address")
    print("  âœ“ The malicious phishing address")
    print("  âœ“ Which field was modified")
    print("\n" + "="*60)
    print("Here is your flag:")
    print("="*60)
    print(flag)
    print("\n" + "="*60)
    print("KEY LEARNINGS")
    print("="*60)
    print("\nâ€¢ diff compares files line by line")
    print("â€¢ '<' shows content from the first file (legitimate)")
    print("â€¢ '>' shows content from the second file (phishing)")
    print("â€¢ grep filters output to find specific patterns")
    print("â€¢ Phishing attacks make subtle changes to steal funds")
    print("\nAlways verify wallet addresses before confirming transactions!")

def main():
    # Check if files exist
    if not os.path.exists(LEGIT_FILE) or not os.path.exists(PHISHING_FILE):
        setup_files()
        return
    
    # Files exist, run verification
    print("\n" + "="*60)
    print("Ready to verify your phishing analysis!")
    print("="*60)
    print("\nMake sure you've explored the files using:")
    print("  â€¢ diff (basic comparison)")
    print("  â€¢ diff | grep '>' (phishing changes)")
    print("  â€¢ diff | grep '<' (legitimate content)")
    print("  â€¢ diff | grep '0x' (wallet addresses)")
    
    proceed = input("\nHave you completed the analysis? (yes/no): ").strip().lower()
    
    if proceed not in ['yes', 'y']:
        print("\nCome back after you've explored with diff!")
        sys.exit(0)
    
    # Ask verification questions
    if ask_questions():
        award_flag()
    else:
        print("\n" + "="*60)
        print("Keep practicing with diff! Try the commands again.")
        print("="*60)
        sys.exit(1)

if __name__ == "__main__":
    main()
