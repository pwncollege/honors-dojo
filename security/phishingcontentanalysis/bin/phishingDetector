#!/usr/bin/exec-suid -- /usr/local/bin/python -I

import os
import sys

def create_legitimate_html():
    """Create the legitimate MetaMask HTML file."""
    return '''<!DOCTYPE html>
<html>
<head>
    <title>MetaMask - Confirm Transaction</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f6f6f6; margin: 0; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { color: #f6851b; font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .fox-icon { font-size: 40px; margin-bottom: 15px; }
        h2 { margin: 20px 0; color: #24292e; }
        .tx-details { margin: 25px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .label { color: #6a737d; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .value { font-size: 18px; font-weight: 600; margin: 8px 0 15px 0; color: #24292e; word-break: break-all; }
        .confirm-btn { background: #f6851b; color: white; padding: 16px; width: 100%; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .confirm-btn:hover { background: #e47316; }
        .reject-btn { background: white; color: #6a737d; padding: 16px; width: 100%; border: 2px solid #e1e4e8; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="fox-icon">ü¶ä</div>
        <div class="logo">MetaMask</div>
        <h2>Confirm Transaction</h2>

        <div class="tx-details">
            <div class="label">FROM</div>
            <div class="value">0x1a2b3c4d5e6f7890abcdef1234567890abcdef12</div>
        </div>

        <div class="tx-details">
            <div class="label">TO</div>
            <div class="value">0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb</div>
        </div>

        <div class="tx-details">
            <div class="label">AMOUNT</div>
            <div class="value">1.5 ETH</div>
        </div>

        <div class="tx-details">
            <div class="label">GAS FEE (ESTIMATED)</div>
            <div class="value">0.002 ETH</div>
        </div>

        <div class="tx-details">
            <div class="label">TOTAL</div>
            <div class="value">1.502 ETH</div>
        </div>

        <button class="confirm-btn">Confirm</button>
        <button class="reject-btn">Reject</button>
    </div>
</body>
</html>'''

def create_phishing_html(flag_content):
    """Create the phishing MetaMask HTML file with malicious wallet address."""
    return f'''<!DOCTYPE html>
<html>
<head>
    <title>MetaMask - Confirm Transaction</title>
    <style>
        body {{ font-family: Arial, sans-serif; background: #f6f6f6; margin: 0; padding: 20px; }}
        .container {{ max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
        .logo {{ color: #f6851b; font-size: 28px; font-weight: bold; margin-bottom: 10px; }}
        .fox-icon {{ font-size: 40px; margin-bottom: 15px; }}
        h2 {{ margin: 20px 0; color: #24292e; }}
        .tx-details {{ margin: 25px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }}
        .label {{ color: #6a737d; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }}
        .value {{ font-size: 18px; font-weight: 600; margin: 8px 0 15px 0; color: #24292e; word-break: break-all; }}
        .confirm-btn {{ background: #f6851b; color: white; padding: 16px; width: 100%; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }}
        .confirm-btn:hover {{ background: #e47316; }}
        .reject-btn {{ background: white; color: #6a737d; padding: 16px; width: 100%; border: 2px solid #e1e4e8; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }}
    </style>
</head>
<body>
    <div class="container">
        <div class="fox-icon">ü¶ä</div>
        <div class="logo">MetaMask</div>
        <h2>Confirm Transaction</h2>

        <div class="tx-details">
            <div class="label">FROM</div>
            <div class="value">0x1a2b3c4d5e6f7890abcdef1234567890abcdef12</div>
        </div>

        <div class="tx-details">
            <div class="label">TO</div>
            <div class="value">0xDEADBEEF_PHISHING_{flag_content}</div>
        </div>

        <div class="tx-details">
            <div class="label">AMOUNT</div>
            <div class="value">1.5 ETH</div>
        </div>

        <div class="tx-details">
            <div class="label">GAS FEE (ESTIMATED)</div>
            <div class="value">0.002 ETH</div>
        </div>

        <div class="tx-details">
            <div class="label">TOTAL</div>
            <div class="value">1.502 ETH</div>
        </div>

        <button class="confirm-btn">Confirm</button>
        <button class="reject-btn">Reject</button>
    </div>
</body>
</html>'''

def setup_and_award_flag():
    """Create the HTML files and award the flag."""
    # Try to read the flag
    try:
        with open("/flag", 'r') as f:
            flag_content = f.read().strip()
    except FileNotFoundError:
        flag_content = "pwn.college{DEMO_FLAG_WOULD_APPEAR_HERE}"

    # Create files in home directory
    home_dir = os.path.expanduser("~")
    legitimate_path = os.path.join(home_dir, "legitimate_metamask.html")
    phishing_path = os.path.join(home_dir, "phishing_metamask.html")

    # Write the HTML files
    with open(legitimate_path, 'w') as f:
        f.write(create_legitimate_html())

    with open(phishing_path, 'w') as f:
        f.write(create_phishing_html(flag_content))

    print("="*60)
    print("PHISHING CONTENT ANALYSIS - Challenge Setup")
    print("="*60)
    print("\nTwo HTML files have been created:")
    print(f"  1. {legitimate_path}")
    print(f"  2. {phishing_path}")
    print("\n" + "üé≠"*30)
    print("\nScenario:")
    print("  Multiple users reported losing funds after 'confirming'")
    print("  MetaMask transactions. You've obtained both the legitimate")
    print("  and phishing HTML pages.")
    print("\n  The phishing page looks IDENTICAL to MetaMask's real UI,")
    print("  but somewhere in the code, the destination wallet address")
    print("  has been changed to steal user funds.")
    print("\n" + "üîç"*30)
    print("\nLet's use diff to find the malicious change:")
    print("\nCommand: diff legitimate_metamask.html phishing_metamask.html")
    print("\nLet's filter to show only the phishing file's changes:")
    print("Command: diff legitimate_metamask.html phishing_metamask.html | grep '>'")
    print("\n" + "-"*60)

    # Run diff and show output
    import subprocess
    try:
        result = subprocess.run(
            ['diff', legitimate_path, phishing_path],
            capture_output=True,
            text=True
        )
        # diff returns non-zero when files differ, which is expected
        if result.stdout:
            print("\nDiff output:")
            print(result.stdout)

        # Now show just the phishing line
        result2 = subprocess.run(
            f"diff {legitimate_path} {phishing_path} | grep '>'",
            shell=True,
            capture_output=True,
            text=True
        )
        print("\nPhishing line (grep '>'):")
        print(result2.stdout)

    except Exception as e:
        print(f"\nNote: diff command output shown above")

    print("-"*60)

    print("\n" + "="*60)
    print("‚úì Phishing destination wallet found!")
    print("‚úì Malicious address identified!")
    print("="*60)

    print("\n" + "="*60)
    print("SUCCESS! Here is your flag:")
    print("="*60)
    print(flag_content)

    print("\n" + "="*60)
    print("SECURITY LESSON LEARNED")
    print("="*60)
    print("\nPhishing attacks in crypto are devastating because:")
    print("  ‚Ä¢ Transactions are irreversible")
    print("  ‚Ä¢ No customer support to reverse fraud")
    print("  ‚Ä¢ Attackers can create pixel-perfect clones")
    print("  ‚Ä¢ One character different in a 42-char address is hard to spot")
    print("\n" + "‚ö†Ô∏è"*30)
    print("\nHow the attack works:")
    print("  1. Attacker clones legitimate website (MetaMask, Uniswap, etc.)")
    print("  2. Changes destination wallet address to their own")
    print("  3. Buys Google ads or sends phishing emails")
    print("  4. Victims think they're on real site")
    print("  5. Funds sent to attacker's wallet")
    print("\nDefend yourself:")
    print("  ‚úì Bookmark legitimate sites, never click email links")
    print("  ‚úì Verify URLs character by character")
    print("  ‚úì Use hardware wallet with on-device address verification")
    print("  ‚úì Enable transaction simulation (Pocket Universe, Fire)")
    print("  ‚úì Check SSL certificates")
    print("  ‚úì Never enter seed phrases on websites")
    print("\nReal victims:")
    print("  ‚Ä¢ $8M stolen via fake Uniswap interface (2023)")
    print("  ‚Ä¢ Thousands lost funds to MetaMask phishing (2022)")
    print("  ‚Ä¢ OpenSea NFT phishing campaign (2022)")

def main():
    """Main validation logic."""
    setup_and_award_flag()

if __name__ == "__main__":
    main()
