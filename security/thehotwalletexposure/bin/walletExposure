#!/usr/bin/exec-suid -- /usr/local/bin/python -I

import os
import sys
import random
import string

WALLET_PRIVATE_KEY_VAR = "WALLET_PRIVATE_KEY"
BASHRC_PATH = os.path.expanduser("~/.bashrc")
ENV_VARS_FILE = os.path.expanduser("~/.hidden_env_vars")
ANSWER_FILE = os.path.expanduser("~/.wallet_key_answer")

def generate_random_string(length=20):
    """Generate a random string for decoy values."""
    chars = string.ascii_letters + string.digits
    return ''.join(random.choices(chars, k=length))

def setup_environment():
    """Set up environment with noise to force grep usage."""
    
    # Check if already setup
    files_exist = os.path.exists(ENV_VARS_FILE)
    bashrc_linked = False
    if os.path.exists(BASHRC_PATH):
        with open(BASHRC_PATH, 'r') as f:
            if f"source {ENV_VARS_FILE}" in f.read():
                bashrc_linked = True

    if files_exist and bashrc_linked:
        return

    # Generate random private key WITHOUT flag
    real_key_value = '0x' + ''.join(random.choices(string.hexdigits.lower(), k=64))

    # Store the correct answer for later verification
    with open(ANSWER_FILE, 'w') as f:
        f.write(real_key_value)
    os.chmod(ANSWER_FILE, 0o600)  # Owner read/write only
    
    # Generate 500 decoy variables
    print("Generating environment noise...")
    decoys = []
    
    # Add some realistic-looking but fake variables
    prefixes = ["CONFIG", "APP", "DB", "AWS", "NODE", "REACT", "VUE", "PYTHON", "JAVA", "GO"]
    suffixes = ["KEY", "SECRET", "TOKEN", "ID", "URL", "PATH", "VERSION", "MODE", "DEBUG"]
    
    for i in range(500):
        if random.random() < 0.3:
            # Structured fake variable
            key = f"{random.choice(prefixes)}_{random.choice(suffixes)}_{generate_random_string(4).upper()}"
        else:
            # Random junk variable
            key = f"VAR_{generate_random_string(8).upper()}"
            
        val = generate_random_string(random.randint(20, 60))
        decoys.append(f"export {key}='{val}'")
        
    # Insert real key at random position
    insert_pos = random.randint(0, len(decoys))
    decoys.insert(insert_pos, f"export {WALLET_PRIVATE_KEY_VAR}='{real_key_value}'")
    
    # Write to hidden file
    with open(ENV_VARS_FILE, 'w') as f:
        f.write("# System Environment Variables (Do not edit)\n")
        f.write("\n".join(decoys))
        f.write("\n")
        
    # Source in bashrc if not already there
    if not bashrc_linked:
        with open(BASHRC_PATH, 'a') as f:
            f.write(f"\n# Challenge 2 Setup\nsource {ENV_VARS_FILE}\n")

    print("Environment initialized with noise.")
    print(f"Generated {len(decoys)} environment variables.")
    print("\nTo complete this challenge:")
    print("  1. Run: source ~/.bashrc")
    print("  2. Find the WALLET_PRIVATE_KEY using grep/printenv/echo")
    print("  3. Submit it: walletExposure <private_key>\n")
    sys.exit(0)

def verify_submission(submitted_key):
    """Verify the student's submitted private key."""
    # Check if challenge is set up
    if not os.path.exists(ANSWER_FILE):
        print("‚ùå Error: Challenge not set up yet.")
        print("\nPlease run 'walletExposure' first to initialize the environment.")
        return False

    # Read stored answer
    with open(ANSWER_FILE, 'r') as f:
        correct_key = f.read().strip()

    # Normalize inputs (strip whitespace, case-insensitive comparison)
    submitted = submitted_key.strip().lower()
    correct = correct_key.strip().lower()

    # Compare
    if submitted == correct:
        return True

    # Provide helpful feedback for common mistakes
    if submitted == correct.replace('0x', ''):
        print("‚ùå Almost! Don't forget the '0x' prefix.")
        return False
    if '0x' + submitted == correct:
        print("‚ùå Close! Remove the extra '0x' - the key should start with 0x.")
        return False

    return False

def award_flag():
    """Award the flag to the student."""
    # Read the actual flag
    try:
        with open("/flag", 'r') as f:
            flag = f.read().strip()
    except FileNotFoundError:
        flag = "pwn.college{demo_flag_hot_wallet}"

    print("‚úì Correct! You successfully found the exposed WALLET_PRIVATE_KEY\n")
    print("=" * 60)
    print("SUCCESS! Here is your flag:")
    print("=" * 60)
    print(flag)
    print()
    print("üîí Security Lesson:")
    print("   Never store private keys in environment variables!")
    print("   - Environment variables are inherited by child processes")
    print("   - They can be logged accidentally")
    print("   - They're visible in process listings")
    print("   - Use hardware wallets or secret management systems instead")
    print("=" * 60)

def main():
    # Check if student provided a private key argument
    if len(sys.argv) > 1:
        # Verification mode: student submitting answer
        submitted_key = sys.argv[1]

        if verify_submission(submitted_key):
            award_flag()
            sys.exit(0)
        else:
            print("‚ùå Incorrect private key. Try again.")
            print("\nHints:")
            print("  - Make sure you copied the entire key including '0x' prefix")
            print("  - The key should be 66 characters (0x + 64 hex digits)")
            print("  - Use: env | grep WALLET_PRIVATE_KEY")
            sys.exit(1)

    # Setup mode: no arguments provided
    setup_environment()

if __name__ == "__main__":
    main()
