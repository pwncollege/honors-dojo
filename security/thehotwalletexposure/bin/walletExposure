#!/usr/bin/exec-suid -- /usr/local/bin/python -I

import os
import sys

WALLET_PRIVATE_KEY_VAR = "WALLET_PRIVATE_KEY"
BASHRC_PATH = os.path.expanduser("~/.bashrc")

def setup_environment():
    """Set up environment on first run by adding to .bashrc."""
    # Check if already in .bashrc
    is_setup = False
    if os.path.exists(BASHRC_PATH):
        with open(BASHRC_PATH, 'r') as f:
            if "export " + WALLET_PRIVATE_KEY_VAR in f.read():
                is_setup = True

    if not is_setup:
        try:
            with open("/flag", 'r') as f:
                flag = f.read().strip()
        except FileNotFoundError:
            flag = "pwn.college{demo_flag_hot_wallet}"

        key_value = f"0x1234567890abcdef_FLAG:{flag}"
        
        with open(BASHRC_PATH, 'a') as f:
            f.write(f"\n# Challenge 2 Setup\nexport {WALLET_PRIVATE_KEY_VAR}='{key_value}'\n")
        
        print("Environment initialized.")
        print(f"Added {WALLET_PRIVATE_KEY_VAR} to {BASHRC_PATH}")
        print("Please run the following command to load the changes:")
        print("\n    source ~/.bashrc\n")
        print("Then run this script again to verify.")
        sys.exit(0)

def check_solution():
    """Verify student found the wallet private key (by checking if it's in env)."""
    if WALLET_PRIVATE_KEY_VAR not in os.environ:
        print(f"Error: {WALLET_PRIVATE_KEY_VAR} environment variable not found in current session.")
        print("\nPossible reasons:")
        print("1. You haven't run 'source ~/.bashrc' yet.")
        print("2. You haven't run this script once to set up the environment.")
        print("\nTry running: source ~/.bashrc")
        return False
    return True

def award_flag():
    """Award the flag."""
    print(f"âœ“ Found exposed {WALLET_PRIVATE_KEY_VAR} environment variable")
    print("\n" + "="*50)
    print("SUCCESS! The flag is in the private key value:")
    print("="*50)
    print(f"{os.environ[WALLET_PRIVATE_KEY_VAR]}")

def main():
    setup_environment()
    if not check_solution():
        sys.exit(1)
    award_flag()

if __name__ == "__main__":
    main()
